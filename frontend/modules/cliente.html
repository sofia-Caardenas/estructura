<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cliente - Cafetería</title>
    <link rel="stylesheet" href="../src/assets/css/cliente.css">
    
    <!-- Incluimos Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
</head>
<body>
    <header>
        <div class="logo">
            <a class="logo"><img src="../src/assets/img/logocafsenablanco.png" width="25%" height="100%" alt="Logo Cafetería"></a>
        </div>
        <nav>
            <ul>
                <li><a href="#" onclick="showProfile(); return false;">Perfil de Usuario</a></li>
                <li><a href="#" onclick="showMenu(); return false;">Ver Menú</a></li>
                <li><a href="#" onclick="showCart(); return false;">Carrito de compras</a></li>
                <li><a href="#" onclick="checkOrderStatus(); return false;">Pedidos</a></li>
                <li><a href="#" onclick="showOrderHistory(); return false;">Historial de Pedidos</a></li>
            </ul>
        </nav>
        <button class="logout-button" onclick="logout()">Cerrar Sesión</button>
    </header>
    <div class="container">
        <h1 class="section-title">Panel de cliente</h1>
        <div id="content">
            <!-- Contenido dinámico de cada sección -->
            <p>Bienvenido al panel de cliente. Selecciona una opción del menú para comenzar.</p>
        </div>
    </div>

    <footer>
        <p>&copy; 2024 Onix. Todos los derechos reservados.</p>
    </footer>

    <!-- Incluimos las librerías de Toastr JS y jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script>
        let cart = [];
        let orders = [];

        // Mostrar el perfil del cliente desde localStorage
// Mostrar el perfil del cliente desde localStorage
function showProfile() {
    const user = JSON.parse(localStorage.getItem('loggedInUser'));

    if (user) {
        const profileContent = 
            `<div class="profile">
                <h2>Perfil de Usuario</h2>
                <div class="profile-info">
                    <p><strong>Nombre:</strong> ${user.name}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Teléfono:</strong> ${user.phone}</p>
                </div>
                <button class="btn" onclick="editProfile()">Editar Perfil</button>
            </div>`;
        document.getElementById('content').innerHTML = profileContent;
    } else {
        toastr.warning('No hay información de perfil disponible.', 'Advertencia');
    }
}

// Editar el perfil del cliente
function editProfile() {
    const user = JSON.parse(localStorage.getItem('loggedInUser'));

    if (user) {
        const editProfileContent = 
            `<div class="profile">
                <h2>Editar Perfil</h2>
                <form id="editProfileForm">
                    <div class="form-group">
                        <label for="name">Nombre:</label>
                        <input type="text" id="name" name="name" value="${user.name}" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" value="${user.email}" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Teléfono:</label>
                        <input type="tel" id="phone" name="phone" value="${user.phone}" required>
                    </div>
                    <button type="submit" class="btn">Guardar Cambios</button>
                </form>
            </div>`;
        document.getElementById('content').innerHTML = editProfileContent;

        document.getElementById('editProfileForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const updatedUser = {
                ...user,
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value
            };
            localStorage.setItem('loggedInUser', JSON.stringify(updatedUser));
            showProfile();
            toastr.success('Perfil actualizado correctamente.', 'Éxito');
        });
    }
}

        // Mostrar el menú de productos
        
        function showMenu() {
    const menuContent = `
        <div id="productos" class="menu-section" style="display:block;">
            <h2>Productos</h2>
            <div class="search-bar" style="text-align:center;">
                <input type="text" id="search-productos" placeholder="Buscar productos..." 
                onkeyup="searchTable('productos-table', 'search-productos')" style="padding: 10px; width: 60%; border: 1px solid #ccc; border-radius: 5px; font-size: 16px;">
            </div>
            <br><br>
            <table id="productos-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f2f2f2; color: #333;">
                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">ID</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">Nombre</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">Precio</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">Descripción</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    `;
    document.getElementById('content').innerHTML = menuContent;

    // Fetch de datos desde la API
    fetch('http://localhost:8080/api/v1/Productos/getProductos')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => llenarTablaProducto(data))
        .catch(error => console.error('Error al obtener los datos:', error));
}

function llenarTablaProducto(data) {
    const tabla = document.getElementById('productos-table').getElementsByTagName('tbody')[0];
    tabla.innerHTML = ''; 
    data.forEach(producto => {
        const fila = tabla.insertRow();
        fila.style.borderBottom = '1px solid #ddd';
        fila.style.textAlign = 'center';
        
        const idCell = fila.insertCell(0);
        const nombreCell = fila.insertCell(1);
        const precioCell = fila.insertCell(2);
        const descripcionCell = fila.insertCell(3);
        const accionCell = fila.insertCell(4); // Nueva celda para acciones
        
        // Asegurarse de que los datos de la API contienen ID, nombre y precio
        if (!producto.id || !producto.nombre || !producto.precio) {
            console.warn('Producto con datos incompletos:', producto);
            return;
        }

        idCell.textContent = producto.id; // Mostrar el ID del producto
        nombreCell.textContent = producto.nombre;
        precioCell.textContent = `$${producto.precio.toFixed(2)}`;
        descripcionCell.textContent = producto.descripcion;

        // Crear botón para añadir al carrito
        const addButton = document.createElement('button');
        addButton.textContent = 'Añadir al carrito';
        addButton.style.padding = '8px 12px';
        addButton.style.backgroundColor = '#4CAF50';
        addButton.style.color = '#fff';
        addButton.style.border = 'none';
        addButton.style.borderRadius = '5px';
        addButton.style.cursor = 'pointer';

        // Pasar el ID del producto junto con nombre y precio
        addButton.onclick = () => addToCart(producto.id, producto.nombre, producto.precio);

        accionCell.appendChild(addButton);

        [idCell, nombreCell, precioCell, descripcionCell, accionCell].forEach(cell => {
            cell.style.padding = '10px';
        });
    });
}



// Carrito global


// Añadir producto al carrito
function addToCart(id, product, price) {
    const existingItem = cart.find(item => item.id === id);

    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cart.push({ id, product, price, quantity: 1 });
    }

    toastr.success('Producto añadido al carrito.', 'Éxito');
}







// Función para agrupar productos iguales
// Función para agrupar productos iguales
function groupCartItems(cart) {
    const groupedItems = {};

    cart.forEach(item => {
        if (groupedItems[item.product]) {
            groupedItems[item.product].quantity += item.quantity;  // Suma la cantidad
        } else {
            groupedItems[item.product] = { ...item };
        }
    });

    return Object.values(groupedItems);
}


// Función para aumentar la cantidad de un producto
// Función para aumentar la cantidad de un producto
function increaseQuantity(productName) {
    const item = cart.find(item => item.product === productName);
    if (item) {
        item.quantity += 1; // Incrementa la cantidad
    }
    showCart(); // Actualizar el carrito
}

// Función para disminuir la cantidad de un producto
function decreaseQuantity(productName) {
    const item = cart.find(item => item.product === productName);
    if (item) {
        if (item.quantity > 1) {
            item.quantity -= 1; // Disminuye la cantidad
        } else {
            cart = cart.filter(item => item.product !== productName); // Elimina el producto si la cantidad es 1
        }
    }
    showCart(); // Actualizar el carrito
}


// Mostrar el carrito de compras con paginación y control de cantidad
let cartPage = 1; // Nueva variable específica para el carrito
const itemsPerPage = 5; // Productos por página en el carrito

// Mostrar el carrito de compras con paginación
// Mostrar el carrito de compras con paginación y control de cantidad
function showCart() {
    const totalAmount = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);

    const cartContent = `
        <section class="cart-section">
            <h2>Carrito de compras</h2>
            ${cart.length === 0 ? '<p>No tienes productos en el carrito.</p>' : '<ul class="cart-items">'}
            ${cart.map(item => 
                `<li class="cart-item">
                    <div class="item-details">
                        <span class="item-name">${item.product} x${item.quantity}</span>
                        <span class="item-price">| $${(item.price * item.quantity).toLocaleString('es-ES', { minimumFractionDigits: 0 })}</span>
                    </div>
                    <div class="item-actions">
                        <button onclick="decreaseQuantity('${item.product}')" class="quantity-button">-</button>
                        <span class="item-quantity">${item.quantity}</span>
                        <button onclick="increaseQuantity('${item.product}')" class="quantity-button">+</button>
                        <button onclick="removeFromCart('${item.product}')" class="remove-button">Eliminar</button>
                    </div>
                </li>`
            ).join('')}
            ${cart.length > 0 ? '</ul><div class="total">Total: $' + totalAmount.toLocaleString('es-ES', { minimumFractionDigits: 0 }) + '</div><button class="order-button" onclick="placeOrder()">Realizar Pedido</button>' : ''}
        </section>`;

    document.getElementById('content').innerHTML = cartContent;
}



// Función para cambiar de página en el carrito
function changeCartPage(page) {
    cartPage = page;
    showCart();
}


// Función para eliminar completamente un producto del carrito
function removeFromCart(productName) {
    cart = cart.filter(item => item.product !== productName); // Elimina completamente el producto
    showCart(); // Vuelve a mostrar el carrito actualizado
    toastr.info('Producto eliminado del carrito.', 'Información'); // Mensaje de confirmación
}





// Función para cambiar de página
function changePage(page) {
    currentPage = page;
    showCart();
}

// Función para agrupar productos por cantidad en el pedido
function groupCartItemsForOrder(cart) {
    const groupedItems = {};

    cart.forEach(item => {
        if (groupedItems[item.product]) {
            groupedItems[item.product].quantity += 1; // Incrementar la cantidad
        } else {
            groupedItems[item.product] = { ...item, quantity: 1 }; // Inicializar con cantidad 1
        }
    });

    return Object.values(groupedItems); // Convertir el objeto en un array
}

// Realizar pedido
function placeOrder() {
    const orders = JSON.parse(localStorage.getItem('orders')) || [];
    const newOrder = {
        id: orders.length + 1,
        items: [...cart],
        status: 'Pendiente'
    };

    orders.push(newOrder);
    localStorage.setItem('orders', JSON.stringify(orders));

    cart = [];  // Vaciar el carrito después de realizar el pedido
    showCart(); // Actualizar la vista del carrito
    checkOrderStatus(); // Mostrar el estado del pedido
}

// Ver estado de pedidos (sin imagen)
// Variables de paginación para pedidos
let currentOrderPage = 1;
const orderItemsPerPage = 4;

// Ver estado de pedidos con paginación
// Ver estado de pedidos con paginación
function checkOrderStatus() {
    let orders = JSON.parse(localStorage.getItem('orders')) || [];
    const activeOrders = orders.filter(order => order.status !== 'Entregado');

    const totalOrderItems = activeOrders.length;
    const totalOrderPages = Math.ceil(totalOrderItems / orderItemsPerPage);

    const startIndex = (currentOrderPage - 1) * orderItemsPerPage;
    const endIndex = Math.min(startIndex + orderItemsPerPage, totalOrderItems);
    
    const paginatedOrders = activeOrders.slice(startIndex, endIndex);

    let orderStatusContent = `
        <section class="order-status-section">
            <h2 class="section-title">Estado de los Pedidos</h2>
            ${paginatedOrders.length === 0 ? '<p>No tienes pedidos realizados.</p>' : '<div class="order-status-grid">'}
            ${paginatedOrders.map(order => {
                const orderTotal = order.items.reduce((acc, item) => acc + item.price * item.quantity, 0);
                return `
                    <div class="order-item">
                        <h3>Pedido #${order.id}</h3>
                        <ul>
                            ${order.items.map(item => 
                                `<li>${item.product} x${item.quantity} - $${item.price}</li>`
                            ).join('')}
                        </ul>
                        <p><strong>Total:</strong> $${orderTotal.toLocaleString('es-ES', { minimumFractionDigits: 0 })}</p>
                        <p><strong>Estado:</strong> <span>${order.status}</span></p>
                    </div>`;
            }).join('')}
            ${paginatedOrders.length > 0 ? '</div>' : ''}
        </section>`;

    orderStatusContent += `
        <div class="pagination">
            ${currentOrderPage > 1 ? `<button onclick="changeOrderPage(${currentOrderPage - 1})">Anterior</button>` : ''}
            ${Array.from({ length: totalOrderPages }, (_, i) => 
                `<button onclick="changeOrderPage(${i + 1})" ${currentOrderPage === i + 1 ? 'disabled' : ''}>${i + 1}</button>`
            ).join('')}
            ${currentOrderPage < totalOrderPages ? `<button onclick="changeOrderPage(${currentOrderPage + 1})">Siguiente</button>` : ''}
        </div>`;

    document.getElementById('content').innerHTML = orderStatusContent;
}


// Función para cambiar de página en los pedidos activos
function changeOrderPage(page) {
    currentOrderPage = page;
    checkOrderStatus();
}




// Mostrar historial de pedidos con estilo encapsulado y paginación
// Variables de paginación
let currentHistoryPage = 1;
const historyItemsPerPage = 6;

// Función para mostrar el historial de pedidos con paginación
// Función para mostrar el historial de pedidos con paginación
function showOrderHistory() {
    let orderHistory = JSON.parse(localStorage.getItem('orderHistory')) || [];
    const totalHistoryItems = orderHistory.length;
    const totalHistoryPages = Math.ceil(totalHistoryItems / historyItemsPerPage);

    const startIndex = (currentHistoryPage - 1) * historyItemsPerPage;
    const endIndex = Math.min(startIndex + historyItemsPerPage, totalHistoryItems);
    
    const paginatedHistory = orderHistory.slice(startIndex, endIndex);

    let historyContent = `
        <section class="order-history-section">
            <h2>Historial de Pedidos</h2>
            <div class="order-history-grid">`; // Agregar contenedor para el grid

    paginatedHistory.forEach((order) => {
        const orderTotal = order.items.reduce((acc, item) => acc + item.price * item.quantity, 0);
        historyContent += `
            <div class="order-history-item"> <!-- Cambiar a div para usar grid -->
                <h3>Pedido #${order.id}</h3>
                <ul>
                    ${order.items.map(item => 
                        `<li>${item.product} x${item.quantity} - $${item.price}</li>`
                    ).join('')}
                </ul>
                <p><strong>Total:</strong> $${orderTotal.toLocaleString('es-ES', { minimumFractionDigits: 0 })}</p>
            </div>`; // Cambiar cierre a div
    });

    historyContent += `
            </div>
        </section>`; // Cerrar el contenedor del grid

    historyContent += `
        <div class="pagination">
            ${currentHistoryPage > 1 ? `<button onclick="changeHistoryPage(${currentHistoryPage - 1})">Anterior</button>` : ''}
            ${Array.from({ length: totalHistoryPages }, (_, i) => 
                `<button onclick="changeHistoryPage(${i + 1})" ${currentHistoryPage === i + 1 ? 'disabled' : ''}>${i + 1}</button>`
            ).join('')}
            ${currentHistoryPage < totalHistoryPages ? `<button onclick="changeHistoryPage(${currentHistoryPage + 1})">Siguiente</button>` : ''}
        </div>
        </section>`;

    document.getElementById('content').innerHTML = historyContent;
}


// Función para cambiar de página en el historial de pedidos
function changeHistoryPage(page) {
    currentHistoryPage = page;
    showOrderHistory();
}



// Función para cambiar de página
function changePage(page) {
    currentPage = page;
    showOrderHistory();
}


// Cerrar sesión
function logout() {
    toastr.info('Sesión cerrada.', 'Información');
    window.location.href = "login.html"; // Redirige a la página de login
}

// Mostrar contenido de bienvenida al cargar la página
window.onload = function() {
    const contentDiv = document.getElementById('content');
    contentDiv.innerHTML = `
        <h2>Bienvenido al panel de cliente</h2>
        <p>Selecciona una opción del menú para comenzar.</p>`;
};
</script>
</body>
</html>
