<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cliente - Cafetería</title>
    <link rel="stylesheet" href="../src/assets/css/cliente.css">
    
    <!-- Incluimos Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
</head>
<body>
    <header>
        <div class="logo">
            <a class="logo"><img src="../src/assets/img/logocafsenablanco.png" width="25%" height="100%" alt="Logo Cafetería"></a>
        </div>
        <nav>
            <ul>
                <li><a href="#" onclick="showProfile(); return false;">Perfil de Usuario</a></li>
                <li><a href="#" onclick="showMenu(); return false;">Ver Menú</a></li>
                <li><a href="#" onclick="showCart(); return false;">Carrito de compras</a></li>
                <li><a href="#" onclick="checkOrderStatus(); return false;">Pedidos</a></li>
                <li><a href="#" onclick="showOrderHistory(); return false;">Historial de Pedidos</a></li>
            </ul>
        </nav>
        <button class="logout-button" onclick="logout()">Cerrar Sesión</button>
    </header>
    <div class="container">
        <h1 class="section-title">Panel de cliente</h1>
        <div id="content">
            <!-- Contenido dinámico de cada sección -->
            <p>Bienvenido al panel de cliente. Selecciona una opción del menú para comenzar.</p>
        </div>
    </div>

    <footer>
        <p>&copy; 2024 Onix. Todos los derechos reservados.</p>
    </footer>

    <!-- Incluimos las librerías de Toastr JS y jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script>
        let cart = [];
        let orders = [];

        // Mostrar el perfil del cliente desde localStorage
        function showProfile() {
            const user = JSON.parse(localStorage.getItem('loggedInUser'));

            if (user) {
                const profileContent = 
                    `<div class="profile">
                        <h2>Perfil de Usuario</h2>
                        <p><strong>Nombre:</strong> ${user.name}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Teléfono:</strong> ${user.phone}</p>
                        <button onclick="editProfile()">Editar Perfil</button>
                    </div>`;
                document.getElementById('content').innerHTML = profileContent;
            } else {
                toastr.warning('No hay información de perfil disponible.', 'Advertencia');
            }
        }

        // Editar el perfil del cliente
        function editProfile() {
            const user = JSON.parse(localStorage.getItem('loggedInUser'));

            if (user) {
                const editProfileContent = 
                    `<div class="profile">
                        <h2>Editar Perfil</h2>
                        <form id="editProfileForm">
                            <label for="name">Nombre:</label>
                            <input type="text" id="name" name="name" value="${user.name}" required>
                            <label for="email">Email:</label>
                            <input type="email" id="email" name="email" value="${user.email}" required>
                            <label for="phone">Teléfono:</label>
                            <input type="tel" id="phone" name="phone" value="${user.phone}" required>
                            <button type="submit">Guardar Cambios</button>
                        </form>
                    </div>`;
                document.getElementById('content').innerHTML = editProfileContent;

                document.getElementById('editProfileForm').addEventListener('submit', function(event) {
                    event.preventDefault();
                    const updatedUser = {
                        ...user,
                        name: document.getElementById('name').value,
                        email: document.getElementById('email').value,
                        phone: document.getElementById('phone').value
                    };
                    localStorage.setItem('loggedInUser', JSON.stringify(updatedUser));
                    showProfile();
                    toastr.success('Perfil actualizado correctamente.', 'Éxito');
                });
            }
        }

        // Mostrar el menú de productos
        function showMenu() {
            const menuContent = 
                `<section class="menu-section" id="menu">
                    <h2 class="section-title">Platos del día</h2>
                    <div class="products">
                        <div class="product">
                            <img src="../src/assets/img/carneasada.png" alt="Carne asada">
                            <div class="product-title">Carne asada</div>
                            <div class="product-price">$8.000</div>
                            <a href="#" class="product-button" onclick="addToCart('Carne asada', 8000); return false;">Añadir al carrito</a>
                        </div>
                        <div class="product">
                            <img src="../src/assets/img/costillas de cerdo.png" alt="Costillas de cerdo con salsa BBQ">
                            <div class="product-title">Costillas de cerdo con salsa BBQ</div>
                            <div class="product-price">$8.000</div>
                            <a href="#" class="product-button" onclick="addToCart('Costillas de cerdo con salsa BBQ', 8000); return false;">Añadir al carrito</a>
                        </div>
                        <div class="product">
                            <img src="../src/assets/img/bandeja paisa.png" alt="Bandeja Paisa">
                            <div class="product-title">Bandeja Paisa</div>
                            <div class="product-price">$8.000</div>
                            <a href="#" class="product-button" onclick="addToCart('Bandeja Paisa', 8000); return false;">Añadir al carrito</a>
                        </div>
                        <div class="product">
                            <img src="../src/assets/img/chuleta valluna.png" alt="Chuleta valluna">
                            <div class="product-title">Chuleta valluna</div>
                            <div class="product-price">$8.000</div>
                            <a href="#" class="product-button" onclick="addToCart('Chuleta valluna', 8000); return false;">Añadir al carrito</a>
                        </div>
                        <div class="product">
                            <img src="../src/assets/img/frijolada.png" alt="Frijolada">
                            <div class="product-title">Frijolada</div>
                            <div class="product-price">$8.000</div>
                            <a href="#" class="product-button" onclick="addToCart('Frijolada', 8000); return false;">Añadir al carrito</a>
                        </div>
                        <div class="product">
                            <img src="../src/assets/img/pescado.png" alt="Mojarra frita">
                            <div class="product-title">Mojarra frita</div>
                            <div class="product-price">$8.000</div>
                            <a href="#" class="product-button" onclick="addToCart('Mojarra frita', 8000); return false;">Añadir al carrito</a>
                        </div>
                    </div>
                    <h2 class="section-title">Lo más vendido</h2>
                    <div class="products">
                        <div class="product">
                            <img src="../src/assets/img/empanada.png" alt="Empanada de carne">
                            <div class="product-title">Empanada de carne</div>
                            <div class="product-price">$8.000</div>
                            <a href="#" class="product-button" onclick="addToCart('Empanada de carne', 8000); return false;">Añadir al carrito</a>
                        </div>
                        <div class="product">
                            <img src="../src/assets/img/buñuelo.png" alt="Buñuelos rellenos de arequipe">
                            <div class="product-title">Buñuelos rellenos de arequipe</div>
                            <div class="product-price">$6.000</div>
                            <a href="#" class="product-button" onclick="addToCart('Buñuelos rellenos de arequipe', 6000); return false;">Añadir al carrito</a>
                        </div>
                        <div class="product">
                            <img src="../src/assets/img/arepadehuevo.png" alt="Arepa de huevo">
                            <div class="product-title">Arepa de huevo</div>
                            <div class="product-price">$5.000</div>
                            <a href="#" class="product-button" onclick="addToCart('Arepa de huevo', 5000); return false;">Añadir al carrito</a>
                        </div>
                        <div class="product">
                            <img src="../src/assets/img/pan de bono.png" alt="Pandebonos">
                            <div class="product-title">Pandebonos</div>
                            <div class="product-price">$4.000</div>
                            <a href="#" class="product-button" onclick="addToCart('Pandebonos', 4000); return false;">Añadir al carrito</a>
                        </div>
                            <div class="product">
                            <img src="../src/assets/img/cafe.png" alt="Pandebonos">
                            <div class="product-title">Cafe </div>
                            <div class="product-price">$4.000</div>
                            <a href="#" class="product-button" onclick="addToCart('Pandebonos', 4000); return false;">Añadir al carrito</a>
                        </div>

                    </div>
                </section>`;
            document.getElementById('content').innerHTML = menuContent;
        }

        // Añadir producto al carrito
        function addToCart(product, price, imageUrl) {
            const newItem = {
                product: product,
                price: price,
                imageUrl: imageUrl
            };
            cart.push(newItem);
            toastr.success('Producto añadido al carrito.', 'Éxito');
        }

        let currentPage = 1;
const itemsPerPage = 5;

// Función para agrupar productos iguales
function groupCartItems(cart) {
    const groupedItems = {};

    cart.forEach(item => {
        if (groupedItems[item.product]) {
            groupedItems[item.product].quantity += 1;
        } else {
            groupedItems[item.product] = { ...item, quantity: 1 };
        }
    });

    return Object.values(groupedItems); // Convertir el objeto en un array
}

// Función para aumentar la cantidad de un producto
function increaseQuantity(productName) {
    const itemIndex = cart.findIndex(item => item.product === productName);
    if (itemIndex !== -1) {
        cart.push(cart[itemIndex]); // Agrega una nueva instancia del producto
    }
    showCart(); // Actualizar el carrito
}

// Función para disminuir la cantidad de un producto
function decreaseQuantity(productName) {
    const itemIndex = cart.findIndex(item => item.product === productName);
    if (itemIndex !== -1) {
        cart.splice(itemIndex, 1); // Elimina una instancia del producto
    }
    showCart(); // Actualizar el carrito
}

// Mostrar el carrito de compras con paginación y control de cantidad
function showCart() {
    const groupedCart = groupCartItems(cart); // Agrupar productos iguales
    const totalItems = groupedCart.length;
    const totalPages = Math.ceil(totalItems / itemsPerPage);

    // Limitar el rango de los productos que se mostrarán en la página actual
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, totalItems);

    const paginatedItems = groupedCart.slice(startIndex, endIndex);

    const cartContent = `
        <section class="cart-section">
            <h2>Carrito de compras</h2>
            ${cart.length === 0 ? '<p>No tienes productos en el carrito.</p>' : '<ul class="cart-items">'}
            ${paginatedItems.map((item, index) => 
                `<li class="cart-item">
                    <div class="item-details">
                        <div class="item-info">
                            <span class="item-name">${item.product} x${item.quantity}</span> <!-- Mostrar cantidad -->
                            <span class="item-price">$${item.price}</span>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button onclick="decreaseQuantity('${item.product}')" class="quantity-button">-</button>
                        <span class="item-quantity">${item.quantity}</span>
                        <button onclick="increaseQuantity('${item.product}')" class="quantity-button">+</button>
                        <button onclick="removeFromCart(${startIndex + index})" class="remove-button">Eliminar</button>
                    </div>
                </li>`
            ).join('')}
            ${cart.length > 0 ? '</ul><button class="order-button" onclick="placeOrder()">Realizar Pedido</button>' : ''}
        </section>
        
        <div class="pagination">
            ${currentPage > 1 ? `<button onclick="changePage(${currentPage - 1})">Anterior</button>` : ''}
            ${Array.from({ length: totalPages }, (_, i) => 
                `<button onclick="changePage(${i + 1})" ${currentPage === i + 1 ? 'disabled' : ''}>${i + 1}</button>`
            ).join('')}
            ${currentPage < totalPages ? `<button onclick="changePage(${currentPage + 1})">Siguiente</button>` : ''}
        </div>
    `;

    document.getElementById('content').innerHTML = cartContent;
}

// Función para cambiar de página
function changePage(page) {
    currentPage = page;
    showCart();
}

// Función para eliminar completamente un producto del carrito
function removeFromCart(index) {
    cart.splice(index, 1); // Elimina el producto completamente
    showCart();
}




        // Eliminar producto del carrito
        function removeFromCart(index) {
            cart.splice(index, 1);
            showCart();
            toastr.info('Producto eliminado del carrito.', 'Información');
        }

// Función para agrupar productos por cantidad en el pedido
function groupCartItemsForOrder(cart) {
    const groupedItems = {};

    cart.forEach(item => {
        if (groupedItems[item.product]) {
            groupedItems[item.product].quantity += 1; // Incrementar la cantidad
        } else {
            groupedItems[item.product] = { ...item, quantity: 1 }; // Inicializar con cantidad 1
        }
    });

    return Object.values(groupedItems); // Convertir el objeto en un array
}

// Realizar pedido
function placeOrder() {
    const user = JSON.parse(localStorage.getItem('loggedInUser'));

    // Agrupar los productos antes de guardarlos en el pedido
    const groupedItems = groupCartItemsForOrder(cart);

    const order = {
        id: Date.now(),
        items: groupedItems,  // Usar los productos agrupados
        status: 'En preparación',
        customerName: user.name,
        customerEmail: user.email
    };

    let orders = JSON.parse(localStorage.getItem('orders')) || [];
    orders.push(order);

    localStorage.setItem('orders', JSON.stringify(orders));

    cart = [];
    toastr.success('Pedido realizado con éxito.', 'Éxito');
    showCart();
}

// Ver estado de pedidos (sin imagen)
function checkOrderStatus() {
    let orders = JSON.parse(localStorage.getItem('orders')) || [];
    const activeOrders = orders.filter(order => order.status !== 'Entregado');

    const orderStatusContent = 
        `<section class="order-status">
            <h2 class="section-title">Estado de los Pedidos</h2>
            ${activeOrders.length === 0 ? '<p>No tienes pedidos realizados.</p>' : '<ul class="order-list">'}
            ${activeOrders.map(order => 
                `<li class="order-item">
                    <h3>Pedido #${order.id}</h3>
                    <ul>
                        ${order.items.map(item => 
                            `<li>
                                <div class="item-details">
                                    <div class="item-info">
                                        <span class="item-name">${item.product} x${item.quantity}</span> <!-- Mostrar cantidad correctamente -->
                                        <span class="item-price">$${item.price}</span>
                                    </div>
                                </div>
                            </li>`
                        ).join('')}
                    </ul>
                    <p><strong>Estado:</strong> <span>${order.status}</span></p>
                </li>`
            ).join('')}
            ${activeOrders.length > 0 ? '</ul>' : ''}
        </section>`;
    document.getElementById('content').innerHTML = orderStatusContent;
}

// Mostrar historial de pedidos (sin imagen)
function showOrderHistory() {
    let orderHistory = JSON.parse(localStorage.getItem('orderHistory')) || [];
    
    let historyContent = 
        `<h2>Historial de Pedidos</h2>
        <ul class="history-list">`;

    orderHistory.forEach((order, index) => {
        historyContent += 
            `<li>
                 <h3>Pedido #${order.id}</h3>
                 <ul>
                     ${order.items.map(item => 
                         `<li>${item.product} x${item.quantity} - $${item.price}</li>` // Mostrar cantidad correctamente
                      ).join('')}
                 </ul>
            </li>`;
    });

    historyContent += '</ul>';
    document.getElementById('content').innerHTML = historyContent;
}

// Cerrar sesión
function logout() {
    toastr.info('Sesión cerrada.', 'Información');
    window.location.href = "login.html"; // Redirige a la página de login
}

// Mostrar contenido de bienvenida al cargar la página
window.onload = function() {
    const contentDiv = document.getElementById('content');
    contentDiv.innerHTML = `
        <h2>Bienvenido al panel de cliente</h2>
        <p>Selecciona una opción del menú para comenzar.</p>`;
};
</script>
</body>
</html>
