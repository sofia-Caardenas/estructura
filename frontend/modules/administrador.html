<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <link rel="stylesheet" href="../src/assets/css/administrador.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
</head>
<body>
    <header>
        <div class="logo">
            <a class="logo"><img src="../src/assets/img/logocafsenablanco.png" width="25%" height="100%" alt="Logo Cafetería"></a>
        </div>
        <nav>
            <ul>
                <li><a class="tab-button" onclick="showTab('usuarios')">Usuarios</a></li>
                <li><a class="tab-button" onclick="showTab('productos')">Productos</a></li>
                <li><a class="tab-button" onclick="showTab('historial')">Historial de Pedidos</a></li>
            </ul>
        </nav>
        <button class="logout-button" onclick="logout()">Cerrar Sesión</button>
    </header>

    <div class="container">
        <h1 class="section-title">Panel de Administración</h1>
        <div id="content">
            <!-- Sección Usuarios -->
            <div id="usuarios" class="menu-section active">
                <h2>Usuarios</h2>
                <div class="search-bar">
                    <input type="text" id="search-usuarios" placeholder="Buscar usuarios..." onkeyup="searchTable('usuarios-table', 'search-usuarios')">
                </div>
                <table id="usuarios-table">
                    <thead>
                        <tr>
                            <th>Rol</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="pagination">
                    <button id="prev-page" onclick="changePage(currentPage - 1)">Anterior</button>
                    <span id="page-info"></span>
                    <button id="next-page" onclick="changePage(currentPage + 1)">Siguiente</button>
                </div>
                
                <!-- Botón para agregar usuario -->
                <button onclick="openAddUserModal()">Agregar Usuario</button>

                <!-- Modal para agregar usuario -->
                <div id="addUserModal" class="modal">
                    <div class="modal-content">
                        <span class="close" onclick="closeAddUserModal()">&times;</span>
                        <h2>Agregar Nuevo Usuario</h2>
                        <form id="addUserForm">
                            <label for="nombre">Nombre:</label>
                            <input type="text" id="nombre" name="nombre" required>

                            <label for="email">Email:</label>
                            <input type="email" id="email" name="email" required>

                            <label for="rol">Rol:</label>
                            <select id="rol" name="rol" required>
                                <option value="1">Administrador</option>
                                <option value="2">Empleado</option>
                                <option value="3">Cliente</option>
                            </select>

                            <label for="clave">Contraseña:</label>
                            <input type="password" id="clave" name="clave" required>

                            <button type="submit">Agregar Usuario</button>
                        </form>
                    </div>
                </div>

                <!-- Modal para editar usuario -->
                <div id="editUserModal" class="modal">
                    <div class="modal-content">
                        <span class="close" onclick="closeEditUserModal()">&times;</span>
                        <h2>Editar Usuario</h2>
                        <form id="editUserForm">
                            <input type="hidden" id="edit-user-id">
                            <label for="edit-nombre">Nombre:</label>
                            <input type="text" id="edit-nombre" name="nombre" required>

                            <label for="edit-email">Email:</label>
                            <input type="email" id="edit-email" name="email" required>

                            <label for="edit-rol">Rol:</label>
                            <select id="edit-rol" name="rol" required>
                                <option value="1">Administrador</option>
                                <option value="2">Empleado</option>
                                <option value="3">Cliente</option>
                            </select>

                            <button type="submit">Actualizar Usuario</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sección Productos -->
            <div id="productos" class="menu-section">
                <h2>Productos</h2>
                <div class="search-bar">
                    <input type="text" id="search-productos" placeholder="Buscar productos..." onkeyup="searchTable('productos-table', 'search-productos')">
                </div>
                <table id="productos-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Precio</th>
                            <th>Descripción</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button onclick="openAddProductModal()">Agregar Producto</button>
            </div>

            <!-- Sección Historial de Pedidos -->
            <div id="historial" class="menu-section">
                <h2>Historial de Pedidos</h2>
                <div class="search-bar">
                    <input type="text" id="search-historial" placeholder="Buscar pedidos..." onkeyup="searchTable('historial-table', 'search-historial')">
                </div>
                <table id="historial-table">
                    <thead>
                        <tr>
                            <th>ID Pedido</th>
                            <th>Usuario</th>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2024 Onix. Todos los derechos reservados.</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        let currentPage = 1;
        const recordsPerPage = 2;
        let usuariosData = [];

        // Función para llenar la tabla de usuarios
        function llenarTabla(data) {
            usuariosData = data;
            renderTable();
        }

        // Función para renderizar la tabla según la página actual
        function renderTable() {
            const tabla = document.getElementById('usuarios-table').getElementsByTagName('tbody')[0];
            tabla.innerHTML = '';

            const start = (currentPage - 1) * recordsPerPage;
            const end = start + recordsPerPage;
            const paginatedData = usuariosData.slice(start, end);

            paginatedData.forEach(usuario => {
                const fila = tabla.insertRow();
                fila.insertCell(0).textContent = usuario.roles.nombre;
                fila.insertCell(1).textContent = usuario.nombre;
                fila.insertCell(2).textContent = usuario.email;
                fila.insertCell(3).innerHTML = `<button onclick="editarUsuario(${usuario.id})">Editar</button>`;
            });

            document.getElementById('page-info').textContent = `Página ${currentPage} de ${Math.ceil(usuariosData.length / recordsPerPage)}`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === Math.ceil(usuariosData.length / recordsPerPage);
        }

        // Cambiar de página
        function changePage(page) {
            const totalPages = Math.ceil(usuariosData.length / recordsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTable();
        }

        // Obtener los datos de los usuarios
        fetch('http://demo4284921.mockable.io/api/v1/Usuarios/getUsuarios')
            .then(response => response.json())
            .then(data => llenarTabla(data))
            .catch(error => console.error('Error al obtener los datos de usuarios:', error));

        // Abrir modal de agregar usuario
        function openAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
        }

        // Cerrar modal de agregar usuario
        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
        }

        // Agregar nuevo usuario
        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const nuevoUsuario = {
                id: usuariosData.length + 1,
                roles: { id: document.getElementById('rol').value, nombre: document.getElementById('rol').options[document.getElementById('rol').selectedIndex].text },
                nombre: document.getElementById('nombre').value,
                email: document.getElementById('email').value,
                clave: document.getElementById('clave').value
            };

            usuariosData.push(nuevoUsuario);
            renderTable();
            toastr.success('Usuario agregado exitosamente');
            closeAddUserModal();
            document.getElementById('addUserForm').reset();
        });

        // Editar usuario
        function editarUsuario(id) {
            const usuario = usuariosData.find(u => u.id === id);
            if (usuario) {
                document.getElementById('edit-user-id').value = usuario.id;
                document.getElementById('edit-nombre').value = usuario.nombre;
                document.getElementById('edit-email').value = usuario.email;
                document.getElementById('edit-rol').value = usuario.roles.id;
                document.getElementById('editUserModal').style.display = 'block';
            }
        }

        // Cerrar modal de edición
        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        // Actualizar usuario
        document.getElementById('editUserForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const id = document.getElementById('edit-user-id').value;
            const usuario = usuariosData.find(u => u.id === Number(id));
            if (usuario) {
                usuario.nombre = document.getElementById('edit-nombre').value;
                usuario.email = document.getElementById('edit-email').value;
                usuario.roles.id = document.getElementById('edit-rol').value;
                usuario.roles.nombre = document.getElementById('edit-rol').options[document.getElementById('edit-rol').selectedIndex].text;

                renderTable();
                toastr.success('Usuario actualizado exitosamente');
                closeEditUserModal();
            }
        });

        // Lógica de cierre del modal al hacer clic fuera de él
        window.onclick = function(event) {
            const addModal = document.getElementById('addUserModal');
            const editModal = document.getElementById('editUserModal');
            if (event.target === addModal) {
                closeAddUserModal();
            }
            if (event.target === editModal) {
                closeEditUserModal();
            }
        };

        // Función de búsqueda en la tabla
        function searchTable(tableId, searchInputId) {
            const input = document.getElementById(searchInputId);
            const filter = input.value.toLowerCase();
            const table = document.getElementById(tableId);
            const tr = table.getElementsByTagName("tr");

            for (let i = 1; i < tr.length; i++) {
                const tdNombre = tr[i].getElementsByTagName("td")[1];
                const tdEmail = tr[i].getElementsByTagName("td")[2];
                if (tdNombre || tdEmail) {
                    const txtValueNombre = tdNombre.textContent || tdNombre.innerText;
                    const txtValueEmail = tdEmail.textContent || tdEmail.innerText;
                    if (txtValueNombre.toLowerCase().indexOf(filter) > -1 || txtValueEmail.toLowerCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }       
            }
        }

        // Función para cerrar sesión
        function logout() {
            // Aquí puedes agregar la lógica para cerrar sesión
            alert('Cerrando sesión...');
        }

        // Función para mostrar la sección correspondiente
        function showTab(tabId) {
            const sections = document.querySelectorAll('.menu-section');
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === tabId) {
                    section.classList.add('active');
                }
            });
        }



    // Lógica de cierre del modal al hacer clic fuera de él
    window.onclick = function(event) {
        const addModal = document.getElementById('addProductModal');
        const editModal = document.getElementById('editProductModal');
        if (event.target === addModal) {
            closeAddProductModal();
        }
        if (event.target === editModal) {
            closeEditProductModal();
        }
    };

    // Función de búsqueda en la tabla
    function searchTable(tableId, searchInputId) {
        const input = document.getElementById(searchInputId);
        const filter = input.value.toLowerCase();
        const table = document.getElementById(tableId);
        const tr = table.getElementsByTagName("tr");

        for (let i = 1; i < tr.length; i++) {
            const tdNombre = tr[i].getElementsByTagName("td")[0];
            const tdPrecio = tr[i].getElementsByTagName("td")[1];
            if (tdNombre || tdPrecio) {
                const txtValueNombre = tdNombre.textContent || tdNombre.innerText;
                const txtValuePrecio = tdPrecio.textContent || tdPrecio.innerText;
                if (txtValueNombre.toLowerCase().indexOf(filter) > -1 || txtValuePrecio.toLowerCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }       
        }
    }
</script>

</body>
</html>
